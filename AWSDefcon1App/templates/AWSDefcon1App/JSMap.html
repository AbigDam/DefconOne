     {% extends "AWSDefcon1App/layout.html" %}
     {% block body %}
        <script src="/static/AWSDefcon1App/tiles.js"></script>
        <link rel="stylesheet" href="/static/AWSDefcon1App/style.css" crossorigin="anonymous">

        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>State Images with Colors</title>
    </head>
    <body>
        <div style="display: flex; justify-content: center; align-items: flex-start; margin-bottom: 20px;">
            <!-- Form on the left (optional, can be removed) -->
            <div style="width: 20%; padding: 10px; margin-right: 20px; display: flex; flex-direction: column; gap: 20px;">
                <h3 style="text-align: center;">Requests Left: {{requesters}}</h3>
                <!-- First Form -->
                <form method="post" action="{% url 'beg' game_id=game_id %}" style="padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-shadow: 1px 1px 5px rgba(0, 0, 0, 0.2);">
                    {% csrf_token %}
                    <h3 style="text-align: center;">Ask allies for aid</h3>

                    <div style="text-align: center;" class = "info-bubble">
                        <span class="info-icon">ðŸ›ˆ</span> 
                        <input class="image-button" type="image" src="/static/AWSDefcon1App/RequestAid.png" 
                            alt="Submit" class="submit-button"
                            style="border: 2px solid white; border-radius: 10px; width: 100px; cursor: pointer; display: block; margin: 0 auto;">
                        <span class="tooltip-text">
                            Uses a diplomatic request, asks every single ally to give you aid, 
                            each has a chance to give you aid based on hostility
                        </span> 
                    </div>
                </form>
        
                <!-- Second Form -->
                <form method="post" action="{% url 'makealliance' game_id=game_id %}" style="padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-shadow: 1px 1px 5px rgba(0, 0, 0, 0.2);">
                    {% csrf_token %}
                    <input type="hidden" name="selected_nation" id="alliance-input" value="">
                    <h3 id="offerDisplay" style="text-align: center;">No Nation Selected </h3>
                    <h4 id="offerHostility" style="text-align: center;">Test Hostility</h4> 
                    <div style = "text-align: center;" class="info-bubble"> <span class="info-icon">ðŸ›ˆ</span> 
                    <button type="submit" style="display: block; width: 100%; padding: 10px; color: black;  background-color: #000000; border: none; border-radius: 5px; cursor: pointer;"><img class="image-button" src="/static/AWSDefcon1App/Alliance_Offer.png" alt="Offer" style = "height: 100px;"> </button>
                    <span class="tooltip-text">Asks a nation to join your alliance, their chance to join is based on hostility</span> 
                </div>
                </form>
        
                <!-- Third Form -->
                <div style="padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-shadow: 1px 1px 5px rgba(0, 0, 0, 0.2);">
                    {% for alliance in alliances %}
                    <h3 style=" text-align: center; font-weight: bold; ">{{ alliance.nation1.name }} is asking for you to join their team</h3>
                    <form method="post" action="{% url 'makealliance' game_id=game_id %}">
                        {% csrf_token %}
                        <div style="text-align: center;">
                        <!-- Accepting nation -->
                        <input type="hidden" name="accepting_nation" value="{{ alliance.nation1.name }}">
                        <button type="submit" name="action" value="accept" style="background: none; border: none; padding: 0; cursor: pointer;">
                            <img class="image-button" style = "width: 100px;" src="/static/AWSDefcon1App/Alliance.png" alt="Accept">
                        </button>
                        
                        <!-- Rejecting nation -->
                        <input type="hidden" name="rejected_nation" value="{{ alliance.nation1.name }}">
                        <button type="submit" name="action" value="reject" style="background: none; border: none; padding: 0; cursor: pointer;">
                            <img class="image-button" style = "width: 100px;" src="/static/AWSDefcon1App/Alliance_Reject.png" alt="Reject">
                        </button>
                        </div>
                    </form>            
                    {% endfor %}
                    </div>

                    <button id="openWarsBtn"
                            style="margin-top:15px; padding:10px 16px; font-size:16px; cursor:pointer;">
                        Diplomacy
                    </button>
                    
                    <!-- Current Wars Overlay -->
                    <div id="warsOverlay" style="
                        display:none;
                        position:fixed;
                        inset:0;
                        background:rgba(0,0,0,0.6);
                        z-index:1000;
                        align-items:center;
                        justify-content:center;
                    ">

                        <!-- Current Wars Modal -->
                        <div style="
                            background:#1e1e1e;
                            color:white;
                            width:700px;
                            max-height:85vh;
                            overflow-y:auto;
                            padding:20px;
                            border-radius:10px;
                            position:relative;
                        ">

                            <!-- Close Button -->
                            <button id="closeWarsBtn" style="
                                position:absolute;
                                top:10px;
                                right:10px;
                                background:none;
                                border:none;
                                color:white;
                                font-size:20px;
                                cursor:pointer;
                            ">âœ•</button>

                            <h2 style="text-align:center;">Current Wars</h2>

                            <table style="width:100%; border-collapse: collapse; margin-top:15px;">
                                <thead>
                                    <tr>
                                        <th style="font-size: 20px; text-align:left;">Attacker</th>
                                        <th style="font-size: 20px; text-align:right;">Defender</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for war in wars %}
                                    <tr>
                                        <!-- Attacker Column -->
                                        <td style="color: {% if war.nation1 == playernation %}red; font-weight:bold{% else %}#fff{% endif %}; font-size:18px;'">
                                            {{ war.nation1.name }}
                                            {% if war.nation1 == playernation %}
                                                <form method="post" action="{% url 'current_wars' game_id=game_id %}" style="display:inline;">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="winner" value="{{ war.nation2.name }}">
                                                    <input type="hidden" name="loser" value="{{ war.nation1.name }}">
                                                    <button type="submit" style="
                                                        padding:5px 10px;
                                                        margin-left:8px;
                                                        background:#d53f3f;
                                                        color:white;
                                                        border:none;
                                                        border-radius:5px;
                                                        cursor:pointer;
                                                        font-size:14px;
                                                        transition: background 0.2s ease;
                                                    " 
                                                    onmouseover="this.style.background='#f56565';" 
                                                    onmouseout="this.style.background='#d53f3f';">
                                                        Surrender
                                                    </button>
                                                </form>
                                            {% endif %}
                                        </td>

                                        <!-- Defender Column -->
                                        <td style="text-align:right; vertical-align:top; font-size:18px; color: {% if war.nation2 == playernation %}red; font-weight:bold{% else %}white{% endif %};">
                                            {{ war.nation2.name }}
                                            {% if war.nation2 == playernation %}
                                                <form method="post" action="{% url 'current_wars' game_id=game_id %}" style="display:inline;">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="winner" value="{{ war.nation1.name }}">
                                                    <input type="hidden" name="loser" value="{{ war.nation2.name }}">
                                                    <button type="submit" style="
                                                        padding:5px 10px;
                                                        margin-left:8px;
                                                        background:#d53f3f;
                                                        color:white;
                                                        border:none;
                                                        border-radius:5px;
                                                        cursor:pointer;
                                                        font-size:14px;
                                                        transition: background 0.2s ease;
                                                    " 
                                                    onmouseover="this.style.background='#f56565';" 
                                                    onmouseout="this.style.background='#d53f3f';">
                                                        Surrender
                                                    </button>
                                                </form>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>

                            {% if allies %}
                            <div style="margin-top:20px;">
                                <h3 style="text-align:center; margin-bottom:10px;">Current Allies</h3>
                                <table style="width:100%; border-collapse: collapse; text-align:left;">
                                    <thead>
                                        <tr>
                                            <th style="font-size:16px; padding:6px 8px; border-bottom:2px solid #ccc;">Ally</th>
                                            <th style="font-size:16px; padding:6px 8px; border-bottom:2px solid #ccc;">States</th>
                                            <th style="font-size:16px; padding:6px 8px; border-bottom:2px solid #ccc;">Points</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for ally in allies %}
                                        <tr style="border-bottom:1px solid #444;">
                                            <td style="padding:6px 8px; font-size:14px; color:white;">{{ ally.name }}</td>
                                            <td style="padding:6px 8px; font-size:14px; color:white;">{{ ally.states }}</td>
                                            <td style="padding:6px 8px; font-size:14px; color:white;">{{ ally.points }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% endif %}
                        </div>
                    </div>


            <button id="openHistoryBtn"
                    style="margin-top:15px; padding:10px 16px; font-size:16px; cursor:pointer;">
                History Log
            </button>

            <!-- History Overlay -->
            <div id="historyOverlay" style="
                display:none;
                position:fixed;
                inset:0;
                background:rgba(0,0,0,0.6);
                z-index:1000;
                align-items:center;
                justify-content:center;
            ">

                <!-- History Modal -->
                <div style="
                    background:#1e1e1e;
                    color:white;
                    width:700px;
                    max-height:85vh;
                    overflow-y:auto;
                    padding:20px;
                    border-radius:10px;
                    position:relative;
                ">

                    <!-- Close Button -->
                    <button id="closeHistoryBtn" style="
                        position:absolute;
                        top:10px;
                        right:10px;
                        background:none;
                        border:none;
                        color:white;
                        font-size:20px;
                        cursor:pointer;
                    ">âœ•</button>

                    <h2 style="text-align:center;">History</h2>

                    <div class="game-container">
                        {% if announces %}
                            {% for announce in announces %}
                                <div class="game">
                                    <hr>  
                                    <div class="boxed-list" style="padding:10px; border-radius:5px; border:1px solid #444; box-shadow:1px 1px 5px rgba(0,0,0,0.3); margin-bottom:5px;">
                                        <p class="boxed-list-instance" style="font-size:14px;">{{ announce.text }}</p>
                                        <p style="color:#A9A9A9; font-family:'Hoefler Text', serif; font-style:italic; font-size:10px; margin-top:4px;">
                                            Sent on {{ announce.start_time }}
                                        </p>
                                    </div>
                                    <hr>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="boxed-list" style="padding:10px; border-radius:5px; border:1px solid #444; box-shadow:1px 1px 5px rgba(0,0,0,0.3); text-align:center;">
                                <p class="boxed-list-instance" style="font-size:14px;">No Announcements Yet</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            </div>
            <!-- Canvas in the center -->
                
            <div style=" text-align: center;">
                
                <div id="loading">
                    <img src="/static/AWSDefcon1App/Loading.gif" alt="Loading..." style="width: 1120px; height: 480px;">
                    <canvas style="width: 1120px; height: 480px; background-color: rgba(255,255,255,);"> <img src="/static/AWSDefcon1App/Loading.gif" alt="Loading..." style="width: 1120px; height: 480px;"></canvas>
                </div>
               
               <div style = "align-items: center;">
                <h3 style="text-align:center; align-items: center; gap: 12px;">
                <a href="{% url 'loader' game_id=game_id reload=1 %}"
                    class="reload-map-button">
                    â†» Reload Map
                </a>
                <label style="font-size: 0.9em;">
                    <input type="checkbox" id="stateToggle">
                    Specific state <div class="info-bubble"><span class="info-icon">ðŸ›ˆ</span> <span class="tooltip-text">Chose which state in the nation you will attack from</span> </div>
                </label>
                </h3>
        </div>

                <div> 
                <div id="canvasContainer" style="display: none; position: relative; width: 1120px; height: 480px;">
                    
                    <canvas id="canvas" width="1120" height="480" 
                            style="background-color:#87ceeb; position: absolute; top: 0; left: 0; z-index: 1;">
                    </canvas> 

                    <canvas id="overlayCanvas" width="1120" height="480" 
                            style="position: absolute; top: 0; left: 0; z-index: 10; cursor: crosshair;">
                    </canvas>
                </div>
                    <div style="text-align: center;">
                            Click on the map to interact with a nation
                                <div style="display: inline-block; position: relative;">
                                <form  style="display: inline-block; position: relative;" id="nationForm">
                                <label style="display: inline-block; position: relative;" for="nationSelect">or select a nation from the dropdown</label>
                                <select style="display: inline-block; position: relative;" id="nationSelect" name="nation">
                                    {% for nation in nation_list %}
                                    <option value="{{ nation }}">{{ nation }}</option>
                                    {% endfor %}
                                </select>
                                <button type="submit">Submit</button>
                                </form>
                                </div>
                            <br>
                        </div>
                        
                        <h3> <div class="status-bar">
                        <p id="colorDisplay"></p>
                        <p id="stateCount">Select a nation via the map or dropdown</p>
                        <p id="frontName">No front selected</p>
                        </div>
                              </h3>              
                    </div>
           
                <div id = "peace-form" style="text-align: center; display: none;">
                    <form method="post" action="{% url 'war' game_id=game_id %}">
                        {% csrf_token %}
                        
                        <input type="hidden" name="selected_nation" id="war-input" value=""> 
                        <h4  style="text-align: center;">At peace for now, Declare War?</h4>
                        <button type="submit" style="margin-top: 20px; text-align: center;">
                            <img class="image-button" src = "/static/AWSDefcon1App/DeclareWar.png" alt="Declare Fight" style="width: 100px; height: 100px; border:2px solid #fff; border-radius:5px;"">
                        </button>
                    </form>
                </div>
            
                <div id="battle-form" style="text-align: center; display: none;">
                    <h4 id = "atWar" style="text-align: center; display: none;">At War!</h4> <br>
                    <button id="showDiv1" class="toggle-button"><div class="info-bubble"><span class="info-icon">ðŸ›ˆ</span>Military<span class="tooltip-text">Uses soldeirs to make large attacks, you can only do 5 battles in a turn!</span> </div></button>
                    <button id="showDiv2" class="toggle-button"><div class="info-bubble"><span class="info-icon">ðŸ›ˆ</span>Espionage<span class="tooltip-text">Uses spies to preform special operations, counts as diplomatic requests</span> </div> </button> 
                </div>
                <div id="div2" style = "display: none;" class="toggle-div">
                    <form style = "text-align: center;" action="{% url 'spies' game_id=game_id %}" method="post">
                        {% csrf_token %}
                        
                        <input type="hidden" name="target" id="victim-input" value="">
            
                        <h3 style = "text-align: center;">Requests Left: {{requesters}}</h3>
                        <h4 style = "text-align: center;">Uses diplomatic requests*</h4>
                        
                        <div style="display: inline-block;">
                        <div class="info-bubble">
                        <button type="submit" name="get" value="1" style="background: none; border: none; cursor: pointer; margin-bottom: 10px;">
                            <img class="image-button" src="/static/AWSDefcon1App/Recruit_Double_Agent.gif" alt="Recruit Double Agent" style="border: 2px solid white; border-radius: 10px; width: 100px; display: block; margin: 0 auto;">
                            <figcaption style = "color:#ccc;" >Kidnap Their Spy<span class="info-icon">ðŸ›ˆ</span> <span class="tooltip-text">Try to take 1 spy from your enemy, risk losing 1 spy (Chance of sucess increased by having more spies)</span> </div> </figcaption>
                        </button>
                        </div>

                        <div style="display: inline-block;">
                        <div class="info-bubble">
                        <button type="submit" name="kill" value="1" style="background: none; border: none; cursor: pointer; margin-bottom: 10px;">
                            <img class="image-button" src="/static/AWSDefcon1App/Assassinate_Spy.gif" alt="Assassinate Spy" style="border: 2px solid white; border-radius: 10px; width: 100px; display: block; margin: 0 auto;">
                            <figcaption style = "color:#ccc;">Assassinate Spy<span class="info-icon">ðŸ›ˆ</span> <span class="tooltip-text">Try to kill an enemy spy, risk losing 1 spy (Chance of sucess increased by having more spies)</span> </div></figcaption>
                        </button>
                        </div>

                        <div style="display: inline-block;">
                        <div class="info-bubble">
                        <button type="submit" name="army" value="1" style="background: none; border: none; cursor: pointer; margin-bottom: 10px;">
                            <img class="image-button" src="/static/AWSDefcon1App/Sabotage_Army.gif" alt="Sabotage Army" style="border: 2px solid white; border-radius: 10px; width: 100px; display: block; margin: 0 auto;">
                            <figcaption style = "color:#ccc;">Sabotage Army<span class="info-icon">ðŸ›ˆ</span> <span class="tooltip-text">Try to destroy some of your enemy's divisions, risk losing 1 spy (Chance of sucess increased by having more spies)</span> </div></figcaption>
                        </button>
                        </div>

                        <div style="display: inline-block;">
                        <div class="info-bubble">
                        <button type="submit" name="air" value="1" style="background: none; border: none; cursor: pointer; margin-bottom: 10px;">
                            <img class="image-button" src="/static/AWSDefcon1App/Sabotage_Air_Force.gif" alt="Sabotage Air Force" style="border: 2px solid white; border-radius: 10px; width: 100px; display: block; margin: 0 auto;">
                            <figcaption style = "color:#ccc;">Sabotage Planes<span class="info-icon">ðŸ›ˆ</span> <span class="tooltip-text">Try to destroy some of your enemy's airplanes, risk losing 1 spy (Chance of sucess increased by having more spies)</span> </div></figcaption>
                        </button>
                        </div>

                        <div style="display: inline-block;">
                        <div class="info-bubble">
                        <button type="submit" name="navy" value="1" style="background: none; border: none; cursor: pointer; margin-bottom: 10px;">
                            <img class="image-button" src="/static/AWSDefcon1App/Sabotage_Navy.gif" alt="Sabotage Navy" style="border: 2px solid white; border-radius: 10px; width: 100px; display: block; margin: 0 auto;">
                            <figcaption style = "color:#ccc;">Sabotage Navy<span class="info-icon">ðŸ›ˆ</span> <span class="tooltip-text">Try to destroy some of your enemy's boats, risk losing 1 spy (Chance of sucess increased by having more spies)</span> </div></figcaption>
                        </button>
                        </div>

                        <div style="display: inline-block;">
                        <div class="info-bubble">
                        <button type="submit" name="nuke" value="1" style="background: none; border: none; cursor: pointer; margin-bottom: 10px;">
                            <img class="image-button" src="/static/AWSDefcon1App/Steal_Nuclear_Technology.gif" alt="Steal Nuclear Technology" style="border: 2px solid white; border-radius: 10px; width: 100px; display: block; margin: 0 auto;">
                            <figcaption style = "color:#ccc;">Steal Nuke Tech<span class="info-icon">ðŸ›ˆ</span> <span class="tooltip-text">Try to decrease your nuke time, risk losing 1 spy (Chance of sucess increased by having more spies)</span> </div></figcaption>
                        </button>
                        </div>

                        <div style="display: inline-block;">
                        <div class="info-bubble">
                        <button type="submit" name="coup" value="1" style="background: none; border: none; cursor: pointer; margin-bottom: 10px;">
                            <img class="image-button" src="/static/AWSDefcon1App/Fund_Revolt.gif" alt="Fund Revolt in a Single State" style="border: 2px solid white; border-radius: 10px; width: 100px; display: block; margin: 0 auto;">
                            <figcaption style = "color:#ccc;">Start Revolt<span class="info-icon">ðŸ›ˆ</span> <span class="tooltip-text">Try to capture a random state, risk losing half your spies (Chance of sucess increased by having more spies)</span> </div></figcaption>
                        </button>
                        </div>

                        <div style="display: inline-block;">
                        <div class="info-bubble">
                        <button type="submit" name="civil" value="1" style="background: none; border: none; cursor: pointer; margin-bottom: 10px;">
                            <img class="image-button" src="/static/AWSDefcon1App/Start_Civil_War.gif" alt="Start Civil War" style="border: 2px solid white; border-radius: 10px; width: 100px; display: block; margin: 0 auto;">
                            <figcaption style = "color:#ccc;">Start Uprising<span class="info-icon">ðŸ›ˆ</span> <span class="tooltip-text">Try to capture half your enemies states instantly, risk losing all your spies (Chance of sucess increased by having more spies)</span> </div></figcaption>
                        </button>
                        </div>

                    
                    </form>
                    </div>
            
            <div id="div1" class="toggle-div" style = "display: none;">
            
                {% if active_nations and attacks_left == 0%}
                <h3 style = "text-align: center;">Waiting For: {{ active_nations }}</h3>
                {% else %}
                <h3 style = "text-align: center;">Battles Left: {{ attacks_left }}</h3>
                {% endif %}

                <form method="post" action="{% url 'battle' game_id=game_id %}" style="text-align: center;">
                {% csrf_token %}
                
                <input type="hidden" name="defender" id="defender-input" value="">
                <input type="hidden" name="front_name" id="frontNameInput">

                <div style="display: inline-block;">

                <label for="div_attack" style="font-weight: bold;">Active Armies</label><br>
                <input type="range" id="div_attack" name="div_attack" value="1" min="0" max="{{PlayerAAA.act_divisions}}" style="width: 80%; margin-bottom: 10px;">
                <br>
                <span id="div_attack_label">Amount: 1</span><br><br>


                <div style="display: inline-block;">

                <div class="info-bubble">
                    <button class = "attacker" type="submit" name="action" value="Ndivision">
                        <img class="image-button" src="/static/AWSDefcon1App/Army_man.gif" alt="Normal Ground Attack" style="border: 2px solid white; border-radius: 10px; width: 100px; cursor: pointer; display: block; margin: 0 auto;" >
                    </button>
                    <figcaption> Ground Attack<span class="info-icon">ðŸ›ˆ</span> <span class="tooltip-text">Attempt to take some of your enemies land, make sure you have a land border</span> </div> </figcaption>
                </div>

                <div style="display: inline-block;">
                <div class="info-bubble">
                    <button class = "attacker" class = "attacker" type="submit" name="action" value="division">
                        <img class="image-button" src="/static/AWSDefcon1App/Encirclement_1.gif" alt="Attempt an Encirclement" style="border: 2px solid white; border-radius: 10px; width: 100px; cursor: pointer; display: block; margin: 0 auto;" >
                    </button>
                    <figcaption> Encirclement<span class="info-icon">ðŸ›ˆ</span> <span class="tooltip-text">Risky attack that could lead to major losses on either side (not both)</span> </div> </figcaption>
                </div>
                
                </div>


                <div style="display: inline-block;">

                <label for="boat_attack" style="font-weight: bold;">Active Boats</label><br>
                <input type="range" id="boat_attack" name="boat_attack" value="1" min="0" max="{{PlayerAAA.act_boats}}" style="width: 80%; margin-bottom: 10px;">
                <br>
                <span id="boat_attack_label">Amount: 1</span><br><br>

                <div style="display: inline-block;">
                <div class="info-bubble">
                    <button class = "attacker"  type="submit" name="action" value="Nboat">
                        <img class="image-button" src="/static/AWSDefcon1App/Boat.gif" alt="Attack Their Boats" style="border: 2px solid white; border-radius: 10px; width: 100px; cursor: pointer; display: block; margin: 0 auto;" >
                    </button>
                    <figcaption>Naval Attack<span class="info-icon">ðŸ›ˆ</span> <span class="tooltip-text">Destroys some of your enemies boats, risking your own planes</span> </div> </figcaption>
                </div>
                
                <div style="display: inline-block;">
                <div class="info-bubble">
                    <button class = "attacker"  type="submit" name="action" value="boat">
                        <img class="image-button" src="/static/AWSDefcon1App/Naval_invasion.gif" alt="Naval Invasion" style="border: 2px solid white; border-radius: 10px; width: 100px; cursor: pointer; display: block; margin: 0 auto;">
                    </button>
                    <figcaption> Naval Landing<span class="info-icon">ðŸ›ˆ</span> <span class="tooltip-text">Attempts to take a state bordering the water, a good way to establish a border with someone!</span> </div></figcaption>
                </div>

                </div>


                
                <div style="display: inline-block;">

                <label for="planes_attack" style="font-weight: bold;">Active Planes</label><br>
                <input type="range" id="planes_attack" name="planes_attack" value="1" min="0" max="{{PlayerAAA.act_planes}}" style="width: 80%; margin-bottom: 10px;">
                <br>
                <span id="planes_attack_label">Amount: 1</span><br><br>

                <div style="display: inline-block;">
                <div class="info-bubble">
                    <button class = "attacker" type="submit" name="action" value="Nplanes">
                        <img class="image-button" src="/static/AWSDefcon1App/Plane.gif" alt="Attack Their Planes" style="border: 2px solid white; border-radius: 10px; width: 100px; cursor: pointer; display: block; margin: 0 auto;" > 
                    </button>
                    <figcaption> Planes  Attack<span class="info-icon">ðŸ›ˆ</span> <span class="tooltip-text">Destroys some of your enemies planes, risking your own planes</span> </div>  </figcaption>
                </div>

                <div style="display: inline-block;">
                <div class="info-bubble">
                    <button class = "attacker" type="submit" name="action" value="planes">
                        <img class="image-button" src="/static/AWSDefcon1App/Bombing.gif" alt="Bomb Their Soldiers" style="border: 2px solid white; border-radius: 10px; width: 100px; cursor: pointer; display: block; margin: 0 auto;" >
                    </button>
                    <figcaption>Bomb Army<span class="info-icon">ðŸ›ˆ</span> <span class="tooltip-text">Destroys some of your enemy's soldeirs based on how many planes you have</span> </div> </figcaption>
                </div>
                
                <div style="display: inline-block;">
                <div class="info-bubble">
                    <button class = "attacker" type="submit" name="action" value="Bplanes">
                        <img class="image-button" src="/static/AWSDefcon1App/Plane_bombing_boat_gif.gif" alt="Bomb Their Boats" style="border: 2px solid white; border-radius: 10px; width: 100px; cursor: pointer; display: block; margin: 0 auto;" >
                    </button>
                    <figcaption> Bomb Boats<span class="info-icon">ðŸ›ˆ</span> <span class="tooltip-text">Destroy some of your enemy's boats based on how many planes you have</span> </div> </figcaption>
                </div>
              

                {% if owner.nukes > 0 %}
                <div style="display: inline-block;">
                <div class="info-bubble">
                    <button class = "attacker" type="submit" name="action" value="nuke">
                        <img class="image-button" src="/static/AWSDefcon1App/Nuke.gif" alt="Nuclear Attack" style="border: 2px solid white; border-radius: 10px; width: 100px; cursor: pointer; display: block; margin: 0 auto;" > 
                    </button>
                    <figcaption> Drop Nukes<span class="info-icon">ðŸ›ˆ</span> <span class="tooltip-text">If you have more than 150% of your enemies planes, then this will nuke them.  If you drop enough nukes they will automatically lose!</span> </div></figcaption>
                </div>

                {% else %}
                <div style="display: inline-block;">
                <div class="info-bubble">
                    <button class = "attacker" style="pointer-events: none;">
                        <img class="image-button" src="/static/AWSDefcon1App/Nuke.gif" alt="Nuclear Attack" style="filter: grayscale(100%); border: 2px solid white; border-radius: 10px; width: 100px; cursor: pointer; display: block; margin: 0 auto;" > 
                    </button>
                    <figcaption>Nukes in {{PlayerAAA.nuke_time}} turns<span class="info-icon">ðŸ›ˆ</span> <span class="tooltip-text">In {{PlayerAAA.nuke_time}} turns you will be able to use Nukes</span> </div></figcaption>
                </div>
                {% endif %}
                </div>

            </form>
                      <br> <br>
            </div>   
             <br> <br>     
            <div style="display: flex; justify-content: center; align-items: center; margin-top: 10px;">
                <a class="pass-button" href="{% url 'passer' game_id=game_id %}">
                    End Turn!
                    <div class="info-bubble">
                        <span class="info-icon">ðŸ›ˆ</span>
                        <span class="tooltip-text">
                            End Current Turn
                        </span>
                    </div>
                </a>
            </div>


            
            </div>

            <!-- Boxed list on the right -->
            <div style="width: 20%; margin-left: 20px;">
                
                <div class="game">
                    <hr>
                    <div class="boxed-list" style="border: 1px solid #ccc; padding: 10px; border-radius: 5px; box-shadow: 1px 1px 5px rgba(0, 0, 0, 0.2);">
                        <p class="boxed-list-instance"> News:</p>
                        <p class="boxed-list-instance">{{announce.text}}</p>
                        <p style="color: #A9A9A9; font-family: 'Hoefler Text', serif; font-style: italic; font-size: 10px;"> 
                            Sent on {{announce.start_time}}
                        </p>

                    </div>
                    <hr>
                </div>

                <div id="dev-level-container" style="width:100%; max-width:420px; border: 1px solid #ccc; padding:10px; color:white; font-family:sans-serif;">
                <div  class="info-bubble"> <h4> State Count: {{ PlayerAAA.states }}/902</h4>  <div></div><span class="info-icon" style="margin-right: 5px;">ðŸ›ˆ</span> <span class="tooltip-text" style="font-size: 14px;">This is the amount of land you control</span></div>
                <div  class="info-bubble"> <h4>Development Count: {% if PlayerAAA.states > 250 %}250{% else %} {{ PlayerAAA.states }}{% endif %}/250 </h4> <span class="info-icon" style="margin-right: 5px;">ðŸ›ˆ</span> <span class="tooltip-text" style="font-size: 14px;">This determines how many troops you get each turn, right now it is just state count but capped at 250</span></div>

                <div style="height:16px; background-color:#444; border-radius:8px; overflow:hidden; position:relative;">
                    <div id="dev-bar" style="
                    height:100%;
                    width:0%;
                    background:linear-gradient(90deg, red, orange, yellow, limegreen, cyan);
                    transition:width 0.8s ease-out;">
                    </div>
                </div>

                <div style="display:flex; justify-content:space-between; font-size:0.8rem; color:#aaa; margin-top:4px;">
                    <span>0</span>
                    <span>20</span>
                    <span>50</span>
                    <span>150</span>
                    <span>200</span>
                    <span>250</span>
                </div>
                </div>
                <!-- Open Shop Button -->
                <button id="openShopBtn"
                        style="margin-top:20px; padding:10px 16px; font-size:16px; cursor:pointer;">
                    Supply Market
                </button>
<!-- Shop Overlay -->
<div id="shopOverlay" style="
    display:none;
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.6);
    z-index:1000;
    align-items:center;
    justify-content:center;
">

    <!-- Shop Modal -->
    <div style="
        background:#1e1e1e;
        color:white;
        width:750px;
        max-height:85vh;
        overflow-y:auto;
        padding:20px;
        border-radius:10px;
        position:relative;
    ">

        <!-- Close Button -->
        <button id="closeShopBtn" style="
            position:absolute;
            top:10px;
            right:10px;
            background:none;
            border:none;
            color:white;
            font-size:20px;
            cursor:pointer;
        ">âœ•</button>

        <!-- ================= BUY SUPPLIES ================= -->
        <form method="post" action="{% url 'focus' game_id=game_id %}">
            {% csrf_token %}

            <h3 style="text-align:center;">Buy Supplies</h3>
            <p style="text-align:center;">Focus Points: {{ PlayerAAA.points }}</p>

            <div style="display:flex; justify-content:space-between; flex-wrap:wrap; gap:15px;">

                <!-- AIR -->
                <div class="info-bubble" style="display:flex; align-items:center;">
                    <button type="submit" name="air" value="1" style="background:none; border:none; padding:0; cursor:pointer;">
                        <img class="image-button" src="/static/AWSDefcon1App/Airplane.png" style="height:50px; border:2px solid #fff; border-radius:5px;">
                    </button>
                    <label style="margin-left:8px;">Planes: {{ PlayerAAA.planes }}</label>
                    <span class="info-icon" style="margin-left:6px;">ðŸ›ˆ</span>
                    <span class="tooltip-text">Buy 1000 planes for 1 point</span>
                </div>

                <!-- ARMY -->
                <div class="info-bubble" style="display:flex; align-items:center;">
                    <button type="submit" name="army" value="1" style="background:none; border:none; padding:0; cursor:pointer;">
                        <img class="image-button" src="/static/AWSDefcon1App/Gun.png" style="height:50px; border:2px solid #fff; border-radius:5px;">
                    </button>
                    <label style="margin-left:8px;">Armies: {{ PlayerAAA.divisions }}</label>
                    <span class="info-icon" style="margin-left:6px;">ðŸ›ˆ</span>
                    <span class="tooltip-text">Buy 80 divisions for 1 point</span>
                </div>

                <!-- NAVY -->
                <div class="info-bubble" style="display:flex; align-items:center;">
                    <button type="submit" name="navy" value="1" style="background:none; border:none; padding:0; cursor:pointer;">
                        <img class="image-button" src="/static/AWSDefcon1App/Boat.png" style="height:50px; border:2px solid #fff; border-radius:5px;">
                    </button>
                    <label style="margin-left:8px;">Boats: {{ PlayerAAA.boats }}</label>
                    <span class="info-icon" style="margin-left:6px;">ðŸ›ˆ</span>
                    <span class="tooltip-text">Buy 60 boats for 1 point</span>
                </div>

                <!-- SPIES -->
                <div class="info-bubble" style="display:flex; align-items:center;">
                    <button type="submit" name="spies" value="1" style="background:none; border:none; padding:0; cursor:pointer;">
                        <img class="image-button" src="/static/AWSDefcon1App/Spies.png" style="height:50px; border:2px solid #fff; border-radius:5px;">
                    </button>
                    <label style="margin-left:8px;">Spies: {{ PlayerAAA.spies }}</label>
                    <span class="info-icon" style="margin-left:6px;">ðŸ›ˆ</span>
                    <span class="tooltip-text">Buy 1 new spy</span>
                </div>

                <!-- NUKES -->
                <div class="info-bubble" style="display:flex; align-items:center;">
                    <button type="submit" name="nuke" value="1" style="background:none; border:none; padding:0; cursor:pointer;">
                        <img class="image-button" src="/static/AWSDefcon1App/Nukes.png" style="height:50px; border:2px solid #fff; border-radius:5px;">
                    </button>
                    <label style="margin-left:8px;">Nukes: {{ PlayerAAA.nukes }}</label>
                    <span class="info-icon" style="margin-left:6px;">ðŸ›ˆ</span>
                    <span class="tooltip-text">Build nuke / reduce timer for 2 points</span>
                </div>

                <!-- POLICY -->
                <div class="info-bubble" style="display:flex; align-items:center;">
                    <button type="submit" name="policy" value="1" style="background:none; border:none; padding:0; cursor:pointer;">
                        <img class="image-button" src="/static/AWSDefcon1App/Chains.png" style="height:50px; border:2px solid #fff; border-radius:5px;">
                    </button>
                    <label style="margin-left:8px;">Allies: {{ num_allies }}</label>
                    <span class="info-icon" style="margin-left:6px;">ðŸ›ˆ</span>
                    <span class="tooltip-text">Disband alliance for 2 points</span>
                </div>
            </div>
        </form>

        <!-- Divider -->
        <hr style="margin:25px 0; border:1px solid #444;">

        <!-- ================= SEND SUPPLIES ================= -->
        <form method="post" action="{% url 'send' game_id=game_id %}" style="text-align:center;">
            {% csrf_token %}

            <h3 id="sendText">Donate Supplies</h3>

            <input type="hidden" name="selected_nation" id="send-input" value="">
            <input type="hidden" name="send_type" id="send_type" value="">

            <label style="font-weight:bold;">Enter Percent</label><br>
            <input type="range" id="amount" name="amount" value="1" min="0" max="100"
                   style="width:80%; margin:10px 0;">
            <br>
            <span id="amount_label">Amount: 1</span>
            <br><br>

            <div class="info-bubble">
                <span class="info-icon">ðŸ›ˆ</span>

                <button type="submit" onclick="send_type.value='1'" style="background:none; border:none; cursor:pointer;">
                     <img class="image-button" src="/static/AWSDefcon1App/Gun.png" style="height:50px; border:2px solid #fff; border-radius:5px;">
                </button>

                <button type="submit" onclick="send_type.value='2'" style="background:none; border:none; cursor:pointer;">
                    <img class="image-button" src="/static/AWSDefcon1App/Airplane.png" style="height:50px; border:2px solid #fff; border-radius:5px;">
                </button>

                <button type="submit" onclick="send_type.value='3'" style="background:none; border:none; cursor:pointer;">
                    <img class="image-button" src="/static/AWSDefcon1App/Boat.png" style="height:50px; border:2px solid #fff; border-radius:5px;">
                </button>

                <span class="tooltip-text">
                    Send a percent of units to reduce hostility
                </span>
            </div>
        </form>
    </div>
</div>

<!-- Open Objectives Button -->
<button id="openObjectivesBtn"
        style="margin-top:15px; padding:10px 16px; font-size:16px; cursor:pointer;">
    Objectives
</button>

<!-- Objectives Overlay -->
<div id="objectivesOverlay" style="
    display:none;
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.6);
    z-index:1000;
    align-items:center;
    justify-content:center;
">

    <!-- Objectives Modal -->
    <div style="
        background:#1e1e1e;
        color:white;
        width:600px;
        max-height:80vh;
        overflow-y:auto;
        padding:20px;
        border-radius:10px;
        position:relative;
    ">

        <!-- Close Button -->
        <button id="closeObjectivesBtn" style="
            position:absolute;
            top:10px;
            right:10px;
            background:none;
            border:none;
            color:white;
            font-size:20px;
            cursor:pointer;
        ">âœ•</button>

        <h3 style="text-align:center;">Objectives</h3>

        <hr>

        <div class="boxed-list" style="
            border:1px solid #ccc;
            padding:10px;
            border-radius:5px;
            box-shadow:1px 1px 5px rgba(0,0,0,0.2);
        ">
            <p class="boxed-list-instance">
                Defeat these nations to win the game:
            </p>
            <p class="boxed-list-instance">
                {{ kill_list }}
            </p>
        </div>

        <hr>
    </div>
</div>
       
<table id="nationsTable" class="table table-striped table-sm" style="display: none;">
    <thead  style="display: none;">
        <tr>         
            <th scope="col"><div class="info-bubble">Name<span class="info-icon">ðŸ›ˆ</span> <span class="tooltip-text">Name of Country</span> </div> </th>
            <th scope="col"><div class="info-bubble">States<span class="info-icon">ðŸ›ˆ</span> <span class="tooltip-text">Amount of Land</span> </div> </th>
            <th scope="col"><div class="info-bubble">Alliance Name<span class="info-icon">ðŸ›ˆ</span> <span class="tooltip-text">Name of Alliance (None indicates no alliance)</span> </div> </th>
            <th scope="col"><div class="info-bubble">Times Nuked<span class="info-icon">ðŸ›ˆ</span> <span class="tooltip-text">Number of times they have been nuked</span> </div> </th>
            <th scope="col"><div class="info-bubble">Attacks Left<span class="info-icon">ðŸ›ˆ</span> <span class="tooltip-text">Ammount of attacks left in the turn</span> </div> </th>
            <th scope="col"><div class="info-bubble">Hostility<span class="info-icon">ðŸ›ˆ</span> <span class="tooltip-text">Determined by How much aid you've given them, and determines things like "ask for aid" and "ask to be allies"</span> </div> </th>
            {% if single_player %}
            <th scope="col"><div class="info-bubble">Player<span class="info-icon">ðŸ›ˆ</span> <span class="tooltip-text">Username</span> </div></th>
            {% endif %}   
        </tr>
    </thead>
    <tbody>
        {% for nation in nations %}
        <tr>
            <td scope="row">{{ nation.name }}</td>
            <td scope="row">{{ nation.states }}</td>
            <td scope="row">{{ nation.alliance_name }}</td>
            <td scope="row">{{ nation.nuked }}</td>
            <td scope="row">{{ nation.attacks }}</td>
            <td scope="row">{{ nation.friendlyness }}</td>
            {% if single_player %}
            <td scope="row">{{ nation.user.username }}</td>
            {% endif %}
        </tr>
        {% endfor %}
    </tbody>
</table>   

  <div class="qa-widget">
  <button class="qa-toggle-button">â” How to Play </button>
  <div class="qa-container" style="display: none;">
    <button class="qa-close">âŒ Close</button>
    
    <div class="qa-item"> (Tutorial is not complete, contribute by asking questions to a moderator via the profiles tab)</div>
    <div class="qa-item">
      <button class="qa-question">How to win a game?</button>
      <div class="qa-answer">
      â€¢ Defeat every nation that is a major nation or another player (see: "How to defeat a nation")<br>
      â€¢ This is listed in the "Defeat these nations to win the game:" list<br>
      </div>
    </div>

    <div class="qa-item">
      <button class="qa-question">How to defeat a nation?</button>
      <div class="qa-answer">
      â€¢ Click on the nation, and then click "Declare War"<br>
      â€¢ When you reclick you can attack them using either<br>
      â€¢ Military (see: "How to win military battles") <br>
      â€¢ or Espionage (see "How to win espionage attacks")<br>
      </div>
    </div>

    <div class="qa-item">
      <button class="qa-question">How to win military battles?</button>
      <div class="qa-answer">
      â€¢ A "normal ground attack" will attack a nation from you or your ally's border.  It is won by a bit of luck and mostly having a larger army (see: "How do I grow my army")<br>
      â€¢ An "attempted encirclement attack" will lead to either you or you're enemy randomly taking much more casulties, but victory is still detirmed by having a larger army  (see: "How do I grow my army")<br>
      â€¢ A "naval invasion" will land on your enemies beaches, this can be done when you don't border an enemy, but requires having more boats then an enemy  (see: "How do I grow my army")<br>
      â€¢ You can also use planes to lower you're enemies numbers of sodliers, planes, or boats<br>
      â€¢ Planes can also be used to drop nuclear bombs, though it only works when you have many more planes than your enemy ("See how to get nukes")<br>
      â€¢ A nation will automatically surrender (you get all their land) when it has been nuked a certain number of times, this is based on population<br>
      </div>
    </div>

    <div class="qa-item">
      <button class="qa-question">How to win espionage attacks?</button>
      <div class="qa-answer">
      â€¢ All espionage attacks have at max a 90% chance of succeding<br>
      â€¢ Most attacks requires having double your enemies spies to reach 90% (see: "How to get more spies)<br>
      â€¢ The "revolt" attack requires having tripple your enemies spies to reach 90% (see: "How to get more spies)<br>
      â€¢ The "civil war" attack requires having four times your enemies spies to reach 90% (see: "How to get more spies)<br>
      â€¢ You can never know how many spies your enemy has due to the fog of war <br>
      </div>
    </div>

    <div class="qa-item">
      <button class="qa-question">How to get more spies</button>
      <div class="qa-answer">
      â€¢ Launch "recruiting double agents" attacks on smaller countries<br>
      â€¢ Buy spies using points (see "How to get points")<br>
      â€¢ Getting aid from allies (see "How to maximize allies Aid")<br>
      </div>
    </div>

    <div class="qa-item">
      <button class="qa-question">How to get nukes?</button>
      <div class="qa-answer">
      â€¢ Your "nuke time" is the time left before you get you're next nuke<br>
      â€¢ You can lower "nuke time" by spending points <br>
      â€¢ You can also lower "nuke time" by getting aid from allies<br>
      â€¢ You will also see it go down automatically as time passes<br>
      </div>
    </div>

    <div class="qa-item">
      <button class="qa-question">How do I grow my army?</button>
      <div class="qa-answer">
      â€¢ Gain more states to train soldiers (and boats/plants) automatically<br>
      â€¢ Spend points on buying stuff (see "How to get points")<br>
      â€¢ Get aid from allies (see "How to maximize allies Aid")<br>
      </div>
    </div>

    <div class="qa-item">
      <button class="qa-question">How to get points?</button>
      <div class="qa-answer">
      â€¢ You get 1 point automatically every turn<br>
      â€¢ Get points from allies aid(see "How to maximize allies Aid")<br>
      </div>
    </div>

    <div class="qa-item">
      <button class="qa-question">How to maximize allies Aid</button>
      <div class="qa-answer">
      â€¢ If you don't have an alliance (Nothing written under alliance name) your aid is random and you can't maximize it<br>
      â€¢ If you have an alliance, the more allies you have, the more aid you will gets<br>
      â€¢ Get allies by offering alliance to low-hostility nations (check hostility after clicking a nation)<br>
      â€¢ Get low-hostility nations by giving away resources to nations you want to ally with<br>
      </div>
    </div>


  </div>
</div>


<script>
//Sliders Set up
var slider = document.getElementById("amount");
var output = document.getElementById("amount_label");
output.innerHTML = "Amount: " + slider.value;

slider.oninput = function() {
    output.innerHTML = "Amount: " + slider.value;
}

//Battle Sliders
var div_attack_slider = document.getElementById("div_attack");
var div_attack_output = document.getElementById("div_attack_label");
div_attack_output.innerHTML = "Amount: " + div_attack_slider.value;
div_attack_slider.oninput = function () {
    div_attack_output.innerHTML = "Amount: " + this.value;
};

var boat_attack_slider = document.getElementById("boat_attack");
var boat_attack_output = document.getElementById("boat_attack_label");
boat_attack_output.innerHTML = "Amount: " + boat_attack_slider.value;
boat_attack_slider.oninput = function () {
    boat_attack_output.innerHTML = "Amount: " + this.value;
};

var planes_attack_slider = document.getElementById("planes_attack");
var planes_attack_output = document.getElementById("planes_attack_label");
planes_attack_output.innerHTML = "Amount: " + planes_attack_slider.value;
planes_attack_slider.oninput = function () {
    planes_attack_output.innerHTML = "Amount: " + this.value;
};

//States Bar
document.addEventListener("DOMContentLoaded", function() {
    const states = parseInt("{{ PlayerAAA.states }}") || 0;
    const maxTier = 250;
    const bar = document.getElementById("dev-bar");

    // Clamp states to a max of 250 for the visual bar
    const progress = Math.min(states, maxTier) / maxTier * 100;
    bar.style.width = progress + "%";
});

//Shop logic
const openShopBtn = document.getElementById("openShopBtn");
const closeShopBtn = document.getElementById("closeShopBtn");
const shopOverlay = document.getElementById("shopOverlay");

openShopBtn.addEventListener("click", () => {
    shopOverlay.style.display = "flex";
});

closeShopBtn.addEventListener("click", () => {
    shopOverlay.style.display = "none";
});

// Close when clicking the dark background
shopOverlay.addEventListener("click", (e) => {
    if (e.target === shopOverlay) {
        shopOverlay.style.display = "none";
    }
});

//Onkectoves Logic
const openObjectivesBtn = document.getElementById("openObjectivesBtn");
const closeObjectivesBtn = document.getElementById("closeObjectivesBtn");
const objectivesOverlay = document.getElementById("objectivesOverlay");

openObjectivesBtn.addEventListener("click", () => {
    objectivesOverlay.style.display = "flex";
});

closeObjectivesBtn.addEventListener("click", () => {
    objectivesOverlay.style.display = "none";
});

objectivesOverlay.addEventListener("click", (e) => {
    if (e.target === objectivesOverlay) {
        objectivesOverlay.style.display = "none";
    }
});


const openWarsBtn = document.getElementById("openWarsBtn");
const closeWarsBtn = document.getElementById("closeWarsBtn");
const warsOverlay = document.getElementById("warsOverlay");

openWarsBtn.addEventListener("click", () => {
    warsOverlay.style.display = "flex";
});

closeWarsBtn.addEventListener("click", () => {
    warsOverlay.style.display = "none";
});

// Close when clicking the background
warsOverlay.addEventListener("click", (e) => {
    if (e.target === warsOverlay) {
        warsOverlay.style.display = "none";
    }
});


const openHistoryBtn = document.getElementById("openHistoryBtn");
const closeHistoryBtn = document.getElementById("closeHistoryBtn");
const historyOverlay = document.getElementById("historyOverlay");

openHistoryBtn.addEventListener("click", () => {
    historyOverlay.style.display = "flex";
});

closeHistoryBtn.addEventListener("click", () => {
    historyOverlay.style.display = "none";
});

// Close when clicking the background
historyOverlay.addEventListener("click", (e) => {
    if (e.target === historyOverlay) {
        historyOverlay.style.display = "none";
    }
});

const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
canvas.width = 1120;
canvas.height = 480;
const colorDisplay = document.getElementById('colorDisplay');

const overlay = document.getElementById('overlayCanvas');
const ctxO = overlay.getContext('2d');

overlay.addEventListener('click', function(event) {

    const rect = overlay.getBoundingClientRect();
    
    // Correct for any scaling
    const scaleX = overlay.width / rect.width;
    const scaleY = overlay.height / rect.height;
    
    const x = (event.clientX - rect.left) * scaleX;
    const y = (event.clientY - rect.top) * scaleY;

    // Wipe ONLY the overlay canvas (keeps tiles visible underneath)
    ctxO.clearRect(0, 0, overlay.width, overlay.height);
    if (stateToggle.checked) {
        // Draw the new circle
        ctxO.beginPath();
        ctxO.arc(x, y, 10, 0, Math.PI * 2);
        ctxO.fillStyle = "rgba(255, 0, 0, 0.6)";
        ctxO.fill();
        ctxO.strokeStyle = "red";
        ctxO.lineWidth = 2;
        ctxO.stroke();
    }
});

const bottom = document.getElementById('canvas');
const stateToggle = document.getElementById("stateToggle");

overlay.addEventListener('click', function(event) {
    // 1. Draw the circle on top
    const rect = overlay.getBoundingClientRect();
    const x = event.clientX - rect.left;
    const y = event.clientY - rect.top;
    
    // (Circle drawing code here...)

    // 2. Manually trigger the click on the bottom canvas
    const simulatedClick = new MouseEvent('click', {
        clientX: event.clientX,
        clientY: event.clientY,
        bubbles: true,
        cancelable: true
    });
    
    bottom.dispatchEvent(simulatedClick);
});

const img = new Image();
img.onload = () => {{
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

    document.getElementById('loading').style.display = 'none';
    document.getElementById('canvasContainer').style.display = 'block';
}};
img.crossOrigin = "anonymous"; 
const gameId = '{{ game_id }}';
img.src = `{{path}}`;


let refreshed = false;

const protocol = window.location.protocol === "https:" ? "wss" : "ws";

const socket = new WebSocket(
    `${protocol}://${window.location.host}/ws/refresh/`
);

socket.onmessage = () => {
    if (refreshed) return;
    refreshed = true;
    location.reload();
};


const tileCanvases = [];

async function loadTiles() {
  await Promise.all(
    window.TILES.map((relPath) => {
      return new Promise((resolve) => {
        const img = new Image();
        img.src = `/static/${relPath}`;
        img.onload = () => {
          const canvas = document.createElement("canvas");
          canvas.width = img.width;
          canvas.height = img.height;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0);
          tileCanvases.push({ name: relPath, ctx });
          resolve();
        };
      });
    })
  );
}

loadTiles();

const map = document.getElementById("canvas");
const frontName = document.getElementById('frontName');
const frontNameInput = document.getElementById('frontNameInput');


map.addEventListener("click", (e) => {
    
  if (!stateToggle.checked) {
    frontName.textContent = "";
    frontNameInput.value = "";
    return
  }
  const rect = map.getBoundingClientRect();
  const x = Math.floor(e.clientX - rect.left);
  const y = Math.floor(e.clientY - rect.top);

  for (const tile of tileCanvases) {
    const alpha = tile.ctx.getImageData(x, y, 1, 1).data[3];
    if (alpha > 0) {
      var clean =  tile.name.replace("AWSDefcon1App/white_image/MapChart_Map.", "").replace(/\.png$/, "");
      frontName.textContent = clean + " front";
      break;
    }
  }

  frontNameInput.value = frontName.textContent

});
        const hexToRgb = (hex) => {
            const bigint = parseInt(hex.slice(1), 16);
            const r = (bigint >> 16) & 255;
            const g = (bigint >> 8) & 255;
            const b = bigint & 255;
            return `rgb(${r}, ${g}, ${b})`;
        };
        const rgbToCountry = {};
        for (const country in colors) {
            const rgbColor = hexToRgb(colors[country]);
            rgbToCountry[rgbColor] = country;
        }

    window.addEventListener('DOMContentLoaded', () => {
        const country = localStorage.getItem('selectedCountry');
        const nationSelect = document.getElementById('nationSelect');
        // Check if the country is still a valid option
        const isCountryValid = [...nationSelect.options].some(
            option => option.value === country
        );

        if (country && isCountryValid) {
            const frontName = document.getElementById('frontName');
            const frontNameInput = document.getElementById('frontNameInput');
            frontName.textContent = "";
            frontNameInput.value = "";
            
            const sendText = document.getElementById('sendText');

            colorDisplay.textContent = `${country}`;
            offerDisplay.textContent = `Offer Alliance to ${country}`;
            sendText.textContent = `Donate Supplies to ${country}`; 

            var some_var = "{{ nation_name_at_war }}";
            nationsAtWar = some_var.replaceAll("&#x27;", "");
            var playerA = "{{PlayerAAA.name}}"
            console.log(playerA);
            if (!nationsAtWar.includes(country)) {
                document.getElementById("battle-form").style.display = "none";
                document.getElementById('div1').style.display = "none";
                document.getElementById('div2').style.display = "none";
                document.getElementById('showDiv1').style.display = "none";
                document.getElementById('showDiv2').style.display = "none";
                if(playerA != country && "Ocean" != country){
                    document.getElementById('peace-form').style.display = "block";
                    const warInput = document.getElementById('war-input');
                    const allianceInput = document.getElementById('alliance-input');
                    const sendInput = document.getElementById('send-input');
                    warInput.value = country;
                    sendInput.value = country;
                    allianceInput.value = country;
                }
                if(playerA == country || "Ocean" == country){
                    document.getElementById('peace-form').style.display = "none";
                    offerHostility.textContent = `No Hostility`;
                    stateCount.textContent = `(not divided into states)`;
                }
                
            } else {
                document.getElementById("battle-form").style.display = "block";
                document.getElementById('showDiv1').style.display = "inline-block";
                document.getElementById('showDiv2').style.display = "inline-block";
                document.getElementById('atWar').style.display = "inline-block";
                document.getElementById('peace-form').style.display = "none";
                const victimInput = document.getElementById('victim-input');
                const defenderInput = document.getElementById('defender-input');
                defenderInput.value = country;
                victimInput.value = country;
            }

            console.log("Starting Next Part");
            // Get the table element
            // JavaScript variable 'country' (set this value dynamically)

            // Get the table element and its rows
            const stateCount = document.getElementById('stateCount');
            const filter = country.toLowerCase(); // Convert country to lowercase for case-insensitive comparison
            const nationsTable = document.getElementById('nationsTable'); // Reference the table element
            const rows = nationsTable.getElementsByTagName('tbody')[0].getElementsByTagName('tr'); // Get all rows from the table body
            // Loop through each row in the table
            for (const row of rows) {
                const name = row.cells[0].textContent.toLowerCase(); // Get text content from the 2nd column (index 1) and convert to lowercase

                if (name === filter) {
                    offerHostility.textContent = `Hostility: ${row.cells[5].textContent.toLowerCase()}`;
                    stateCount.textContent = `(States: ${row.cells[1].textContent.toLowerCase()})`;

                } else {
                    row.style.display = "none"; // Hide non-matching rows
                }
            }


        }
    });

    document.getElementById('nationForm').addEventListener('submit', function(event) {
            const frontName = document.getElementById('frontName');
            const frontNameInput = document.getElementById('frontNameInput');
            const sendText = document.getElementById('sendText');

            frontName.textContent = "";
            frontNameInput.value = "";

            event.preventDefault();  
            const country = document.getElementById('nationSelect').value;
            localStorage.setItem('selectedCountry', country);
            console.log(`Closest color name: ${country}`);
            
            colorDisplay.textContent = `${country}`;
            offerDisplay.textContent = `Offer Alliance to ${country}`;
            sendText.textContent = `Donate Supplies to ${country}`; 

            var some_var = "{{ nation_name_at_war }}";
            nationsAtWar = some_var.replaceAll("&#x27;", "");
            var playerA = "{{PlayerAAA.name}}"
            console.log(playerA);
            if (!nationsAtWar.includes(country)) {
                document.getElementById("battle-form").style.display = "none";
                document.getElementById('div1').style.display = "none";
                document.getElementById('div2').style.display = "none";
                document.getElementById('showDiv1').style.display = "none";
                document.getElementById('showDiv2').style.display = "none";
                if(playerA != country && "Ocean" != country){
                    document.getElementById('peace-form').style.display = "block";
                    const warInput = document.getElementById('war-input');
                    const allianceInput = document.getElementById('alliance-input');
                    const sendInput = document.getElementById('send-input');
                    warInput.value = country;
                    sendInput.value = country;
                    allianceInput.value = country;
                }
                if(playerA == country || "Ocean" == country){
                    document.getElementById('peace-form').style.display = "none";
                    offerHostility.textContent = `No Hostility`;
                    stateCount.textContent = `(not divided into states)`;
                }
                
            } else {
                document.getElementById("battle-form").style.display = "block";
                document.getElementById('showDiv1').style.display = "inline-block";
                document.getElementById('showDiv2').style.display = "inline-block";
                document.getElementById('atWar').style.display = "inline-block";
                document.getElementById('peace-form').style.display = "none";
                const victimInput = document.getElementById('victim-input');
                const defenderInput = document.getElementById('defender-input');
                defenderInput.value = country;
                victimInput.value = country;
            }

            console.log("Starting Next Part");
            // Get the table element
            // JavaScript variable 'country' (set this value dynamically)

            // Get the table element and its rows
            
            const filter = country.toLowerCase(); // Convert country to lowercase for case-insensitive comparison
            const nationsTable = document.getElementById('nationsTable'); // Reference the table element
            const offerHostility = document.getElementById('offerHostility');
            const rows = nationsTable.getElementsByTagName('tbody')[0].getElementsByTagName('tr'); // Get all rows from the table body
            // Loop through each row in the table
            for (const row of rows) {
                const name = row.cells[0].textContent.toLowerCase(); // Get text content from the 2nd column (index 1) and convert to lowercase


                if (name === filter) {
                    offerHostility.textContent = `Hostility: ${row.cells[5].textContent.toLowerCase()}`;
                    stateCount.textContent = `(States: ${row.cells[1].textContent.toLowerCase()})`;
                } else {
                    row.style.display = "none"; // Hide non-matching rows
                }
            }

            nationsTable.style.display = "none";

        });

        canvas.addEventListener('click', (event) => {
            const { offsetX, offsetY } = event;
            const imageData = ctx.getImageData(offsetX, offsetY, 1, 1).data;
            const rgb = [imageData[0], imageData[1], imageData[2]]; // Convert to array for distance calculation

            // Initialize variables for tracking the closest color
            var closestColorName = null;
            var smallestDistance = Infinity;

            // Iterate over the dictionary to find the closest color
            for (const [colorRgb, colorName] of Object.entries(rgbToCountry)) {

                const colorRgbArray = colorRgb
                .replace("rgb(", "")  // Remove "rgb("
                .replace(")", "")    // Remove ")"
                .split(",")          // Split on commas
                .map(Number);        // Convert to numbers
                const distance = Math.sqrt(
                    Math.pow(rgb[0] - colorRgbArray[0], 2) +
                    Math.pow(rgb[1] - colorRgbArray[1], 2) +
                    Math.pow(rgb[2] - colorRgbArray[2], 2)
                );


                if (distance < smallestDistance) {
                    smallestDistance = distance;
                    closestColorName = colorName;
                }
            }
            const country = closestColorName;
            localStorage.setItem('selectedCountry', country);
            colorDisplay.textContent = `${country}`;
            offerDisplay.textContent = `Offer Alliance to ${country}`;
            const sendText = document.getElementById('sendText');
            sendText.textContent = `Donate Supplies to ${country}`; 

        var some_var = "{{ nation_name_at_war }}";
        nationsAtWar = some_var.replaceAll("&#x27;", "");
        var playerA = "{{PlayerAAA.name}}"
        if (!nationsAtWar.includes(country)) {
            document.getElementById("battle-form").style.display = "none";
            document.getElementById('div1').style.display = "none";
            document.getElementById('div2').style.display = "none";
            document.getElementById('showDiv1').style.display = "none";
            document.getElementById('showDiv2').style.display = "none";
            if(playerA != country && "Ocean" != country){
                document.getElementById('peace-form').style.display = "block";
                const warInput = document.getElementById('war-input');
                const allianceInput = document.getElementById('alliance-input');
                const sendInput = document.getElementById('send-input');
                warInput.value = country;
                sendInput.value = country;
                allianceInput.value = country;
            }
            if(playerA == country || "Ocean" == country){
                document.getElementById('peace-form').style.display = "none";
                offerHostility.textContent = `No Hostility`;
                stateCount.textContent = `(not divided into states)`;
            }
            
        } else {
            document.getElementById("battle-form").style.display = "block";
            document.getElementById('showDiv1').style.display = "inline-block";
            document.getElementById('showDiv2').style.display = "inline-block";
            document.getElementById('atWar').style.display = "inline-block";
            document.getElementById('peace-form').style.display = "none";
            const victimInput = document.getElementById('victim-input');
            const defenderInput = document.getElementById('defender-input');
            defenderInput.value = country;
            victimInput.value = country;
        }

        console.log("Starting Next Part");
        // Get the table element
        // JavaScript variable 'country' (set this value dynamically)

        // Get the table element and its rows
        
        const filter = country.toLowerCase(); // Convert country to lowercase for case-insensitive comparison
        const nationsTable = document.getElementById('nationsTable'); // Reference the table element
        const rows = nationsTable.getElementsByTagName('tbody')[0].getElementsByTagName('tr'); // Get all rows from the table body

        // Loop through each row in the table
        for (const row of rows) {
            const name = row.cells[0].textContent.toLowerCase(); // Get text content from the 2nd column (index 1) and convert to lowercase

            if (name === filter) {
                offerHostility.textContent = `Hostility: ${row.cells[5].textContent.toLowerCase()}`;
                stateCount.textContent = `(States: ${row.cells[1].textContent.toLowerCase()})`;
            } else {
                row.style.display = "none"; // Hide non-matching rows
            }
        }

        // Make the table visible if at least one row matches
        nationsTable.style.display = "table";

        });

        document.addEventListener('DOMContentLoaded', () => {
            // Get buttons and divs
            const button1 = document.getElementById('showDiv1');
            const button2 = document.getElementById('showDiv2');
            const div1 = document.getElementById('div1');
            const div2 = document.getElementById('div2');
            const battleForm = document.getElementById('battle-form');

            // Ensure battle form is visible
            battleForm.style.display = 'block';

            // Show Div 1 and hide Div 2
            button1.addEventListener('click', () => {
                div1.style.display = 'block';
                div2.style.display = 'none';
            });

            // Show Div 2 and hide Div 1
            button2.addEventListener('click', () => {
                div2.style.display = 'block';
                div1.style.display = 'none';
            });
        });
            document.addEventListener('DOMContentLoaded', () => {
        
                const gifPath = '/static/AWSDefcon1App/Loading_Battle.gif';
                const gifContainer = document.createElement('div');
                const gifImage = document.createElement('img');
        
                // Styling for the gif container
                gifContainer.style.position = 'fixed';
                gifContainer.style.top = '0';
                gifContainer.style.left = '0';
                gifContainer.style.width = '100%';
                gifContainer.style.height = '100%';
                gifContainer.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';  // Semi-transparent black background
                gifContainer.style.display = 'none';  // Hidden initially
                gifContainer.style.justifyContent = 'center';
                gifContainer.style.alignItems = 'center';
                gifContainer.style.zIndex = '9999';  // Ensure it appears above all content
        
                // Setting up the gif image
                gifImage.src = gifPath;
                gifImage.style.maxWidth = '90%';
                gifImage.style.maxHeight = '90%';
        
                gifContainer.appendChild(gifImage);
                document.body.appendChild(gifContainer);
        
                // Event listener for clicks and form submissions
                document.addEventListener('click', (event) => {
                    const target = event.target;
                    if (target.classList.contains('attacker') || target.closest('button.attacker')) {
                        gifContainer.style.display = 'flex';
                        
                        // Automatically hide the gif after a certain duration
                        setTimeout(() => {
                            gifContainer.style.display = 'none';
                        }, 2000000);  
                    }
                });
        
                // Event listener specifically for form submissions
                document.addEventListener('submit', (event) => {
                    const target = event.target;
                    if (target.classList.contains('attacker')) {
                        gifContainer.style.display = 'flex';
    
                    }
                });
        

            });

    document.querySelector('.qa-toggle-button').addEventListener('click', function() {
    const container = document.querySelector('.qa-container');
    container.style.display = (container.style.display === 'none' || container.style.display === '') ? 'block' : 'none';
    });

    document.querySelector('.qa-close').addEventListener('click', function() {
    document.querySelector('.qa-container').style.display = 'none';
    });

    const questions = document.querySelectorAll('.qa-question');
    questions.forEach(q => {
    q.addEventListener('click', function() {
        const answer = this.nextElementSibling;

        // Hide all answers
        document.querySelectorAll('.qa-answer').forEach(a => a.style.display = 'none');

        // Toggle this one
        answer.style.display = 'block';
    });
    });
</script>
{% endblock %}